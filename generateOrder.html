<!DOCTYPE html>
<html>
    <head>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>确认订单 - 二货</title>

        <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css" media="all" />
        <link rel="stylesheet" type="text/css" href="assets/css/font-awesome.min.css" media="all" />
        <link rel="stylesheet" type="text/css" href="assets/css/animate.min.css" media="all" />
        <link rel="stylesheet" type="text/css" href="assets/css/font-electro.css" media="all" />
        <link rel="stylesheet" type="text/css" href="assets/css/owl-carousel.css" media="all" />
        <link rel="stylesheet" type="text/css" href="assets/css/style.css" media="all" />
        <link rel="stylesheet" type="text/css" href="assets/css/colors/yellow.css" media="all" />

        <link rel="stylesheet" href="assets/css/config.css">

        <link href="assets/css/colors/green.css" rel="alternate stylesheet" title="Green color">
        <link href="assets/css/colors/pink.css" rel="alternate stylesheet" title="Pink color">
        <link href="assets/css/colors/blue.css" rel="alternate stylesheet" title="Blue color">
        <link href="assets/css/colors/red.css" rel="alternate stylesheet" title="Red color">
        <link href="assets/css/colors/orange.css" rel="alternate stylesheet" title="Orange color">
        <link href="assets/css/colors/black.css" rel="alternate stylesheet" title="Black color">
        <link href="assets/css/colors/gold.css" rel="alternate stylesheet" title="Gold color">
        <link href="assets/css/colors/yellow.css" rel="alternate stylesheet" title="Yellow color">
        <link href="assets/css/colors/flat-blue.css" rel="alternate stylesheet" title="Flat Blue color">

        <link rel="shortcut icon" href="assets/images/fav-icon.png">
        <link rel="stylesheet" href="assets/css/eh_home.css">
        <script type="text/javascript"src="assets/js/Var.js"></script>
        <style>
            .buy-message{
                width: 400px;
                height: 35px;
                border-radius: 5px;
                font-size: 12px;
                color: #0C0C0C;!important;
                transition: all 0.6s ease;
                line-height: 1.2;
            }
            .buy-message:focus{
                height: 70px;

            }
            .item-tr{
                border-bottom: 1px  dotted #999;
                background-color: #fbfcff;
            }
            .tr-message{
                height: 75px;
                border-bottom: 1px  dotted #80b2ff;
                background-color: #f2f7ff;
            }
            .tr-message span{
                margin-right: 15px;
                font-size: 12px;
                color: #666;
            }

        </style>
    </head>

    <body class="page home page-template-default">
    <div id="page" class="hfeed site">

        <div class="top-bar">
            <div class="container">
                <nav>
                    <ul id="menu-top-bar-left" class="nav nav-inline pull-left animate-dropdown flip">
                        <li class="menu-item animate-dropdown"><a title="欢迎来到二货校园商城" href="index.html" id="welcomeMessage">欢迎来到二货校园商城</a></li>
                    </ul>
                </nav>

                <nav>
                    <ul id="menu-top-bar-right" class="nav nav-inline pull-right animate-dropdown flip">
                        <li class="menu-item animate-dropdown"><a title="柳州" href="#"><i class="ec ec-map-pointer"></i>柳州</a></li>
                        <li class="menu-item animate-dropdown"><a title="我要发布" href="issuedProduct.html"><i class="ec ec-map-pointer"></i>我要发布</a></li>
                        <li class="menu-item animate-dropdown"><a title="购物车" href="cart.html"><i class="ec ec-transport"></i>购物车</a></li>
                        <li class="menu-item animate-dropdown"><a title="我的订单" href="myOrder.html"><i class="ec ec-shopping-bag"></i>我的订单</a></li>
                        <li class="menu-item animate-dropdown " id="xl"><a title="我的账户" href="login.html" class="item-box" id="myAccount" ><i class="ec ec-user"></i>登录</a>

                        </li>
                        <li class="menu-item animate-dropdown reg"><a title="注册" href="register.html"   ><img src="assets/images/reg.png"  style="float: left;margin-right: 6px;margin-top: 4px;">注册</a></li>
                    </ul>
                </nav>
            </div>
        </div><!-- /.top-bar -->

            <header id="masthead" class="site-header header-v2">
    <div class="container">
        <div class="row">


		<div id="primary" class="content-area">
			<main id="main" class="site-main">
				<article class="page type-page status-publish hentry" id="cartBox">
					<header class="entry-header"><h1 itemprop="name" class="entry-title">确认订单</h1></header>


    <table class="shop_table shop_table_responsive cart">
        <thead>
            <tr>
                <th class="product-thumbnail" style="width: 220px;"></th>
                <th class="product-name">宝贝信息</th>
                <th class="product-price">单价</th>
                <th class="product-quantity">数量</th>
                <th class="product-subtotal">小计</th>
            </tr>
        </thead>
        <tbody id="cartList">






        </tbody>
    </table>

				</article>
			</main><!-- #main -->
		</div><!-- #primary -->
	</div><!-- .container -->
</div><!-- #content -->
            </header>

                <footer id="colophon" class="site-footer" style="margin-top: 60px; ">
                    <div class="footer-bottom-widgets">
                        <div class="container">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12 col-md-7 col-md-push-5">

                                    <div class="columns">
                                        <aside id="nav_menu-4" class="widget clearfix widget_nav_menu">
                                            <div class="body">
                                                <h4 class="widget-title">客户服务</h4>
                                                <div class="menu-footer-menu-3-container">
                                                    <ul id="menu-footer-menu-3" class="menu">
                                                        <li class="menu-item"><a href="single-product.html">我的账户</a></li>
                                                        <li class="menu-item"><a href="single-product.html">我的订单</a></li>
                                                        <li class="menu-item"><a href="single-product.html">我的收藏</a></li>
                                                        <li class="menu-item"><a href="single-product.html">客户服务</a></li>
                                                        <li class="menu-item"><a href="single-product.html">常见问题解答</a></li>
                                                        <li class="menu-item"><a href="hsingle-product.html">产品支持</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </aside>
                                    </div><!-- /.columns -->

                                </div><!-- /.col -->

                                <div class="footer-contact col-xs-12 col-sm-12 col-md-5 col-md-pull-7">
                                    <div class="footer-logo">
                                        <svg version="1.1" x="0px" y="0px" width="156px"
                                             height="37px" viewBox="0 0 175.748 42.52" enable-background="new 0 0 175.748 42.52">
                                            <ellipse fill-rule="evenodd" clip-rule="evenodd" fill="#FDD700" cx="170.05" cy="36.341" rx="5.32" ry="5.367"/>
                                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#333E48" d="M30.514,0.71c-0.034,0.003-0.066,0.008-0.056,0.056
						C30.263,0.995,29.876,1.181,29.79,1.5c-0.148,0.548,0,1.568,0,2.427v36.459c0.265,0.221,0.506,0.465,0.725,0.734h6.187
						c0.2-0.25,0.423-0.477,0.669-0.678V1.387C37.124,1.185,36.9,0.959,36.701,0.71H30.514z M117.517,12.731
						c-0.232-0.189-0.439-0.64-0.781-0.734c-0.754-0.209-2.039,0-3.121,0h-3.176V4.435c-0.232-0.189-0.439-0.639-0.781-0.733
						c-0.719-0.2-1.969,0-3.01,0h-3.01c-0.238,0.273-0.625,0.431-0.725,0.847c-0.203,0.852,0,2.399,0,3.725
						c0,1.393,0.045,2.748-0.055,3.725h-6.41c-0.184,0.237-0.629,0.434-0.725,0.791c-0.178,0.654,0,1.813,0,2.765v2.766
						c0.232,0.188,0.439,0.64,0.779,0.733c0.777,0.216,2.109,0,3.234,0c1.154,0,2.291-0.045,3.176,0.057v21.277
						c0.232,0.189,0.439,0.639,0.781,0.734c0.719,0.199,1.969,0,3.01,0h3.01c1.008-0.451,0.725-1.889,0.725-3.443
						c-0.002-6.164-0.047-12.867,0.055-18.625h6.299c0.182-0.236,0.627-0.434,0.725-0.79c0.176-0.653,0-1.813,0-2.765V12.731z
						M135.851,18.262c0.201-0.746,0-2.029,0-3.104v-3.104c-0.287-0.245-0.434-0.637-0.781-0.733c-0.824-0.229-1.992-0.044-2.898,0
						c-2.158,0.104-4.506,0.675-5.74,1.411c-0.146-0.362-0.451-0.853-0.893-0.96c-0.693-0.169-1.859,0-2.842,0h-2.842
						c-0.258,0.319-0.625,0.42-0.725,0.79c-0.223,0.82,0,2.338,0,3.443c0,8.109-0.002,16.635,0,24.381
						c0.232,0.189,0.439,0.639,0.779,0.734c0.707,0.195,1.93,0,2.955,0h3.01c0.918-0.463,0.725-1.352,0.725-2.822V36.21
						c-0.002-3.902-0.242-9.117,0-12.473c0.297-4.142,3.836-4.877,8.527-4.686C135.312,18.816,135.757,18.606,135.851,18.262z
						M14.796,11.376c-5.472,0.262-9.443,3.178-11.76,7.056c-2.435,4.075-2.789,10.62-0.501,15.126c2.043,4.023,5.91,7.115,10.701,7.9
						c6.051,0.992,10.992-1.219,14.324-3.838c-0.687-1.1-1.419-2.664-2.118-3.951c-0.398-0.734-0.652-1.486-1.616-1.467
						c-1.942,0.787-4.272,2.262-7.134,2.145c-3.791-0.154-6.659-1.842-7.524-4.91h19.452c0.146-2.793,0.22-5.338-0.279-7.563
						C26.961,15.728,22.503,11.008,14.796,11.376z M9,23.284c0.921-2.508,3.033-4.514,6.298-4.627c3.083-0.107,4.994,1.976,5.685,4.627
						C17.119,23.38,12.865,23.38,9,23.284z M52.418,11.376c-5.551,0.266-9.395,3.142-11.76,7.056
						c-2.476,4.097-2.829,10.493-0.557,15.069c1.997,4.021,5.895,7.156,10.646,7.957c6.068,1.023,11-1.227,14.379-3.781
						c-0.479-0.896-0.875-1.742-1.393-2.709c-0.312-0.582-1.024-2.234-1.561-2.539c-0.912-0.52-1.428,0.135-2.23,0.508
						c-0.564,0.262-1.223,0.523-1.672,0.676c-4.768,1.621-10.372,0.268-11.537-4.176h19.451c0.668-5.443-0.419-9.953-2.73-13.037
						C61.197,13.388,57.774,11.12,52.418,11.376z M46.622,23.343c0.708-2.553,3.161-4.578,6.242-4.686
						c3.08-0.107,5.08,1.953,5.686,4.686H46.622z M160.371,15.497c-2.455-2.453-6.143-4.291-10.869-4.064
						c-2.268,0.109-4.297,0.65-6.02,1.524c-1.719,0.873-3.092,1.957-4.234,3.217c-2.287,2.519-4.164,6.004-3.902,11.007
						c0.248,4.736,1.979,7.813,4.627,10.326c2.568,2.439,6.148,4.254,10.867,4.064c4.457-0.18,7.889-2.115,10.199-4.684
						c2.469-2.746,4.012-5.971,3.959-11.063C164.949,21.134,162.732,17.854,160.371,15.497z M149.558,33.952
						c-3.246-0.221-5.701-2.615-6.41-5.418c-0.174-0.689-0.26-1.25-0.4-2.166c-0.035-0.234,0.072-0.523-0.045-0.77
						c0.682-3.698,2.912-6.257,6.799-6.547c2.543-0.189,4.258,0.735,5.52,1.863c1.322,1.182,2.303,2.715,2.451,4.967
						C157.789,30.669,154.185,34.267,149.558,33.952z M88.812,29.55c-1.232,2.363-2.9,4.307-6.13,4.402
						c-4.729,0.141-8.038-3.16-8.025-7.563c0.004-1.412,0.324-2.65,0.947-3.726c1.197-2.061,3.507-3.688,6.633-3.612
						c3.222,0.079,4.966,1.708,6.632,3.668c1.328-1.059,2.529-1.948,3.9-2.99c0.416-0.315,1.076-0.688,1.227-1.072
						c0.404-1.031-0.365-1.502-0.891-2.088c-2.543-2.835-6.66-5.377-11.704-5.137c-6.02,0.288-10.218,3.697-12.484,7.846
						c-1.293,2.365-1.951,5.158-1.729,8.408c0.209,3.053,1.191,5.496,2.619,7.508c2.842,4.004,7.385,6.973,13.656,6.377
						c5.976-0.568,9.574-3.936,11.816-8.354c-0.141-0.271-0.221-0.604-0.336-0.902C92.929,31.364,90.843,30.485,88.812,29.55z"/>
                                        </svg>
                                    </div><!-- /.footer-contact -->

                                    <div class="footer-call-us">
                                        <div class="media">
                                            <span class="media-left call-us-icon media-middle"><i class="ec ec-support"></i></span>
                                            <div class="media-body">
                                                <span class="call-us-text">有问题吗 ? 请马上联系我们!</span>
                                                <span class="call-us-number">(800) 8001-1234</span>
                                            </div>
                                        </div>
                                    </div><!-- /.footer-call-us -->


                                    <div class="footer-address">
                                        <strong class="footer-address-title">联系地址</strong>
                                        <address>广西柳州市鱼峰区阳光100 大厦 3-1B</address>
                                    </div><!-- /.footer-address -->

                                    <div class="footer-social-icons">
                                        <ul class="social-icons list-unstyled">
                                            <li><a class="fa fa-qq" href=""></a></li>
                                            <li><a class="fa fa-wechat" href=""></a></li>
                                        </ul>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="copyright-bar">
                        <div class="container">
                            <div class="pull-left flip copyright">&copy; <a href="">eh</a> - 保留所有权利</div>
                            <div class="pull-right flip payment">
                                <div class="footer-payment-logo">
                                    <ul class="cash-card card-inline">
                                        <li class="card-item"><img src="assets/images/footer/payment-icon/1.png" alt="" width="52"></li>

                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </footer>

    </div>

    <script type="text/javascript" src="assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="assets/js/layer/2.4/layer.js"></script>
    <script type="text/javascript" src="assets/js/eh_home.js"></script>

           <script>
           (function($) {

               $('.minus').click(function () {
                   var num=Number($(this).siblings(".qty").val())-1;
                   if (num >= 0){
                       $(this).siblings('.qty').val(num);
                   }else {
                       $(this).siblings('.qty').val(0);
                   }
               });


               $('.plus').click(function () {
                   var num=Number($(this).siblings(".qty").val())+1;
                   if (num >= 0){
                       $(this).siblings('.qty').val(num);
                   }else {
                       $(this).siblings('.qty').val(0);
                   }
               });
            })(jQuery);

           $(function () {
               getheaderMessage();

               var key=getUrlParam("pKey");
               key=uncompileStr(key);
               if(key == "success"){
                   $.ajax({
                       type: "GET",
                       url: serverURL+"/shoppingCart/cartList",
                       data:{"token":localStorage.getItem("eh_token")},
                       dataType:"json",
                       success: function(data){
                           if (data.errorCode == "200"){
                               cartList=data.list;
                               if(cartList.length >0){
                                   var orderBox="",subOrder="",totalOf=0;
                                   $.each(cartList,function (index,c) {
                                       totalOf+=c.product.productPrice*c.number;
                                       var totalP=c.product.productPrice*c.number;
                                       orderBox+=" <tr class=\"product-tr\" >\n" +
                                           "            <td>\n" +
                                           "                <span style=\"font-size: 14px;\" >卖家：<a href=\"#\" >"+c.product.user.userName+"</a></span>\n" +
                                           "            </td>\n" +
                                           "        </tr>\n" +
                                           "        <tr class=\"cart_item item-tr\" >\n" +
                                           "            <td class=\"product-thumbnail\">\n" +
                                           "                <a href=\"single-product.html?pid="+c.product.id+"&target=subOrder&pageType=orderImg\"><img width=\"180\" height=\"180\" src=\"assets/images/products/2.jpg\" title=\""+c.product.productName+"\"></a>\n" +
                                           "            </td>\n" +
                                           "\n" +
                                           "            <td data-title=\"Product\" class=\"product-name\">\n" +
                                           "                <a href=\"single-product.html?pid="+c.product.id+"&target=subOrder&pageType=order\" target=\"_blank\" style=\"display: block;\">"+c.product.productName+"</a>\n" +
                                           "             </td>\n" +
                                           "\n" +
                                           "            <td data-title=\"Price\" class=\"product-price\">\n" +
                                           "                <span class=\"amount\">"+c.product.productPrice.formatMoney(2,"￥","",".")+"</span>\n" +
                                           "            </td>\n" +
                                           "\n" +
                                           "            <td data-title=\"Quantity\" class=\"product-quantity\">\n" +
                                           +c.number+
                                           "            </td>\n" +
                                           "            <td data-title=\"Total\" class=\"product-subtotal\" style=\"width: 229px;\">\n" +
                                           "                <span class=\"amount\">"+totalP.formatMoney(2,"￥","",".")+"</span>\n" +
                                           "            </td>\n" +
                                           "        </tr>\n" +
                                           "        <tr class=\"tr-message\" >\n" +
                                           "            <td  colspan=\"5\" ><span  >给卖家留言:</span><textarea  style=\"resize:none;overflow-y:hidden\"  class=\"buy-message\"name=\"orderMessage\" placeholder=\"填写您需要告诉卖家的信息\"></textarea>" +
                                           "<input type='hidden' class='pid'  value='"+c.product.id+"'>"+
                                           "</td>\n" +
                                           "        </tr>" ;
                                   });

                                   subOrder="<div class=\"cart-collaterals\" style=\"padding-top: 3em;\">\n" +
                                       "\n" +
                                       "                        <div class=\"cart_totals \">\n" +
                                       "\n" +
                                       "                            <h2>购物车总计</h2>\n" +
                                       "\n" +
                                       "                            <table class=\"shop_table shop_table_responsive\">\n" +
                                       "\n" +
                                       "                                <tbody>\n" +
                                       "                                <tr class=\"cart-subtotal\">\n" +
                                       "                                    <th>小计</th>\n" +
                                       "                                    <td data-title=\"Subtotal\"><span class=\"amount\">"+totalOf.formatMoney(2,"￥","",".")+"</span></td>\n" +
                                       "                                </tr>\n" +
                                       "\n" +
                                       "\n" +
                                       "                                <tr class=\"shipping\">\n" +
                                       "                                    <th>其他费用</th>\n" +
                                       "                                    <td data-title=\"Shipping\"><span class=\"amount\">￥0.00</span></td>\n" +
                                       "                                </tr>\n" +
                                       "\n" +
                                       "                                <tr class=\"order-total\">\n" +
                                       "                                    <th>实付款</th>\n" +
                                       "                                    <td data-title=\"Total\"><strong><span class=\"amount\" style=\"color: orangered;font-size:18px;\">"+totalOf.formatMoney(2,"￥","",".")+"</span></strong> </td>\n" +
                                       "                                </tr>\n" +
                                       "                                </tbody>\n" +
                                       "                            </table>\n" +
                                       "                            <button name=\"addOrder\" type=\"button\" id='submitOrder' style=\"float: right;\">提交订单</button>    </div>\n" +
                                       "                    </div>";

                                   $("#cartList").append(orderBox);
                                   $("#cartBox").append(subOrder);
                               }
                           }
                           if (data.errorCode == "500"){
                               layer.msg(data.message);
                           }
                           if (data.errorCode == "501"){
                               layer.msg(data.message);
                               localStorage.removeItem("eh_token");
                           }
                       },
                       error:function (data) {
                           layer.msg("哎呀,系统出错了...");
                       }
                   });

               }


               //提交订单
               $(document).on('click',"#submitOrder",function(){
                    var cartObj=[];
                    for (var i=0;i<$('.pid').length;i++){
                        var lsObj={"pid":parseInt($('.pid:eq('+i+')').val()),"message":$('.pid:eq('+i+')').siblings(".buy-message").val()};
                        cartObj.push(lsObj);
                    }
                   cartObj=JSON.stringify(cartObj);
                   $.ajax({
                       type: "POST",
                       url: serverURL + "/order/order",
                       data: {"token": localStorage.getItem("eh_token"),"ds": cartObj},
                       dataType: "json",
                       success: function (data) {
                            if (data.errorCode == "200"){
                                //先删除cookie中订单id
                                delCookie('orderItem');
                                //在存入cookie
                                var orderObj=[];
                                $.each(data.list,function (index,o) {
                                    var lsObj={"oid":o.id,"oCode":o.orderCode};
                                    orderObj.push(lsObj);
                                });

                                var str = JSON.stringify(orderObj);
                                if( str.length > 0){
                                    str=compileStr(str);//对存入cookie中的数据进行加密
                                    setCookie("orderItem",str,'-1');
                                }
                                layer.msg("提交成功,正在跳到支付页面...",{
                                    time: 1000 //2秒关闭（如果不配置，默认是3秒）
                                },function(){
                                    var key=compileStr("successDoPay");
                                    window.location.href="ehPay.html?payKey="+key;
                                });

                           }
                           if (data.errorCode == "500"){
                                layer.msg(data.message);
                                return false;
                           }
                           if (data.errorCode == "501"){
                               layer.msg(data.message);
                               localStorage.removeItem("eh_token");
                               return false;
                           }
                       },
                       error:function () {
                           layer.msg("抱歉,我们出了点问题...");
                       }
                   });
               });

                //获取url中的参数
               function getUrlParam(name){
                   //构造一个含有目标参数的正则表达式对象
                   var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
                   //匹配目标参数
                   var r = window.location.search.substr(1).match(reg);
                   //返回参数值
                   if (r!=null) return unescape(r[2]);
                   return null;
               }


                //对字符串进行解密
               function uncompileStr(code){
                   code=unescape(code);
                   var c=String.fromCharCode(code.charCodeAt(0)-code.length);
                   for(var i=1;i<code.length;i++)
                   {
                       c+=String.fromCharCode(code.charCodeAt(i)-c.charCodeAt(i-1));
                   }
                   return c;
               }

               //对字符串进行加密
               function compileStr(code){
                   var c=String.fromCharCode(code.charCodeAt(0)+code.length);
                   for(var i=1;i<code.length;i++)
                   {
                       c+=String.fromCharCode(code.charCodeAt(i)+code.charCodeAt(i-1));
                   }
                   return escape(c);
               }


           });
        </script>
    </body>
</html>
